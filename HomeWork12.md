# `Подготовительные операции`

Подготовка таблиц

![Альт-текст](https://i.ibb.co/T4gTxHq/Home-Work12-1.png)

Результат

![Альт-текст](https://i.ibb.co/x1tR39N/Home-Work12-2.png)

![Альт-текст](https://i.ibb.co/TTmPKVd/Home-Work12-3.png)

# `Реализация триггеров`

### `Триггер на добавление записей в таблицу sales`

![Альт-текст](https://i.ibb.co/NT7VHSw/Home-Work12-4.png)

Триггер реализован для события "после добавления" записей в таблицу sales.
Триггерная функция отрабатывает один раз для всего оператора целиком (for each statement) -
это быстрее чем, апдейтить витрину при измении в добавлении каждой записи,
ибо единовременно (одним оператором) в могут быть добавлены сотни тысяч записей.
Процедура создает временную таблицу добавляемых (изменяемых) записей в витрину.
Записи по товарам, которые уже есть в витрине обновляются, записи по новым товарам - добавляются.

### `Тест триггера`

![Альт-текст](https://i.ibb.co/89BXMgd/Home-Work12-5.png)

![Альт-текст](https://i.ibb.co/NT5134T/Home-Work12-6.png)

### `Триггер на изменение записей в таблицу sales`

![Альт-текст](https://i.ibb.co/BLh5zHL/Home-Work12-7.png)

Триггер реализован для события "после изменения" записей в таблице sales.
Триггерная функция отрабатывает один раз для всего оператора целиком (for each statement).

### `Тест триггера`

![Альт-текст](https://i.ibb.co/Wxsv7FQ/Home-Work12-8.png)

![Альт-текст](https://i.ibb.co/899GW53/Home-Work12-9.png)

### `Триггер на удаление записей из таблицы sales`

![Альт-текст](https://i.ibb.co/L97cXTn/Home-Work12-10.png)

Триггер реализован для события "после удаления" записей в таблице sales.
Триггерная функция отрабатывает один раз для всего оператора целиком (for each statement).

### `Тест триггера`

![Альт-текст](https://i.ibb.co/Gp1YsV4/Home-Work12-11.png)

![Альт-текст](https://i.ibb.co/q0jVVBj/Home-Work12-12.png)

**Вопрос: Чем такая схема (витрина+триггер) предпочтительнее отчета, создаваемого "по требованию" (кроме производительности)?**

В витрине всегда актуальные данные, в отчете данные актуальные только на момент получения отчета.
Относительно подсказки "В реальной жизни возможны изменения цен" - для поддержки изменения цен
нужно реализовать аналогичные триггеры для таблицы goods. Кроме того, нужно обеспечить историчность
для значение цены, т.к. одни и те же товары в разние дни могли продаваться по разным ценам.

[Ссылка на скрипт home_work_12.sql](https://github.com/CodeAnalyzer/2022-06-otus-postgres-Fedorov/blob/daa098b145e736fe6116c7b58b348ab2d1892c43/home_work_12.sql) 
